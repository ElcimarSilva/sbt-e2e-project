name: Cypress E2E Tests

on:
    workflow_dispatch:
      inputs:
        browser:
          description: 'Navegador para executar os testes'
          required: false
          default: 'chrome'
          type: choice
          options:
            - chrome
            - firefox
            - edge
        config_file:
          description: 'Arquivo de configura√ß√£o espec√≠fico'
          required: false
          default: 'cypress.config.js'
          type: string
        run_mobile_tests:
          description: 'Executar testes mobile'
          required: false
          default: false
          type: boolean
    push:
      branches:
        - main

jobs:
  cypress-tests:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout c√≥digo
        uses: actions/checkout@v4

      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      - name: Instalar depend√™ncias
        run: npm ci

      - name: Verificar instala√ß√£o do Cypress
        run: npx cypress verify

      - name: Executar testes Cypress (Desktop)
        # Executa por padr√£o em pushes (inputs n√£o existe) ou quando run_mobile_tests √© false
        if: ${{ github.event_name != 'workflow_dispatch' || !inputs.run_mobile_tests }}
        run: |
          if [ "${{ inputs.config_file }}" = "cypress.config.js" ]; then
            npm run cy:run
          else
            npx cypress run --browser ${{ inputs.browser }} --config-file=${{ inputs.config_file }}
          fi
        env:
          CYPRESS_CACHE_FOLDER: ~/.cache/Cypress

      - name: Executar testes Cypress (Mobile)
        # Executa apenas quando trigger for manual (workflow_dispatch) e input run_mobile_tests for true
        if: ${{ github.event_name == 'workflow_dispatch' && inputs.run_mobile_tests }}
        run: npm run cy:run:mobile
        env:
          CYPRESS_CACHE_FOLDER: ~/.cache/Cypress

      - name: Upload relat√≥rios HTML
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: cypress-reports
          path: |
            reports/mocha/
            reports/screenshots/
            reports/videos/
          retention-days: 30

      - name: Upload logs do Cypress
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: cypress-logs
          path: |
            cypress/logs/
            ~/.cache/Cypress/
          retention-days: 7

      - name: Comentar resultado dos testes
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ Testes executados com sucesso!"
            echo "üìä Relat√≥rios dispon√≠veis nos artifacts"
          else
            echo "‚ùå Falha na execu√ß√£o dos testes"
            echo "üìã Verifique os logs nos artifacts"
          fi
